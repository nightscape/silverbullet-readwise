var O=Object.defineProperty;var x=(e,r)=>{for(var t in r)O(e,t,{get:r[t],enumerable:!0})};var A=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var T=new Map,w=0;function g(e){self.postMessage(e)}A&&(globalThis.syscall=async(e,...r)=>await new Promise((t,n)=>{w++,T.set(w,{resolve:t,reject:n}),g({type:"sys",id:w,name:e,args:r})}));function C(e,r){A&&(self.addEventListener("message",t=>{(async()=>{let n=t.data;switch(n.type){case"inv":{let o=e[n.name];if(!o)throw new Error(`Function not loaded: ${n.name}`);try{let s=await Promise.resolve(o(...n.args||[]));g({type:"invr",id:n.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",n.name,"error:",s.message),g({type:"invr",id:n.id,error:s.message})}}break;case"sysr":{let o=n.id,s=T.get(o);if(!s)throw Error("Invalid request id");T.delete(o),n.error?s.reject(new Error(n.error)):s.resolve(n.result)}break}})().catch(console.error)}),g({type:"manifest",manifest:r}))}function _(e){let r=atob(e),t=r.length,n=new Uint8Array(t);for(let o=0;o<t;o++)n[o]=r.charCodeAt(o);return n}function v(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let r="",t=e.byteLength;for(let n=0;n<t;n++)r+=String.fromCharCode(e[n]);return btoa(r)}async function V(e,r){if(typeof e!="string"){let t=new Uint8Array(await e.arrayBuffer()),n=t.length>0?v(t):void 0;r={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,r)}globalThis.nativeFetch=globalThis.fetch;function L(){globalThis.fetch=async function(e,r){let t=r&&r.body?v(new Uint8Array(await new Response(r.body).arrayBuffer())):void 0,n=await V(e,r&&{method:r.method,headers:r.headers,base64Body:t});return new Response(n.base64Body?_(n.base64Body):null,{status:n.status,headers:n.headers})}}A&&L();function l(e,r,t,n){let[o,s]=e;switch(o){case"and":{let i=l(s,r,t,n);return i instanceof Promise?i.then(a=>a&&l(e[2],r,t,n)):i&&l(e[2],r,t,n)}case"or":{let i=l(s,r,t,n);return i instanceof Promise?i.then(a=>a||l(e[2],r,t,n)):i||l(e[2],r,t,n)}case"null":return null;case"not":{let i=l(s,r,t,n);return i instanceof Promise?i.then(a=>!a):!i}case"number":case"string":case"boolean":return s;case"regexp":return[s,e[2]];case"attr":{let i=r;if(e.length===3){let a=l(e[1],r,t,n);return a instanceof Promise?a.then(u=>u[e[2]]):a?a[e[2]]:null}else if(e[1]){let a=i[e[1]],u=n[e[1]];return a===void 0&&u!==void 0&&(a=u(t)),a}else return r}case"global":return t[s];case"array":{let i=s.map(u=>l(u,r,t,n)),a=[];for(let u=0;u<i.length;u++)i[u]instanceof Promise&&a.push(i[u].then(m=>i[u]=m));return a.length>0?Promise.all(a).then(()=>i):i}case"object":{let i=s.map(([u,m])=>[u,l(m,r,t,n)]),a=[];for(let u=0;u<i.length;u++)i[u][1]instanceof Promise&&a.push(i[u][1].then(m=>i[u]=m));return a.length>0?Promise.all(a).then(()=>Object.fromEntries(i)):Object.fromEntries(i)}case"pageref":{let i=n.readPage;if(!i)throw new Error("No readPage function defined");return i(s)}case"query":{let i=e[1],a=n.$query;if(!a)throw new Error("No $query function defined");return a(i,t)}case"call":{let i=n[s];if(!i)throw new Error(`Unknown function: ${s}`);let a=e[2].map(m=>l(m,r,t,n)),u=[];for(let m=0;m<a.length;m++)a[m]instanceof Promise&&u.push(a[m].then(N=>a[m]=N));return u.length>0?Promise.all(u).then(()=>i(...a)):i(...a)}case"-":if(e.length==2)return-l(s,r,t,n)}let f=l(s,r,t,n),p=l(e[2],r,t,n),d=e[3]?l(e[3],r,t,n):void 0;return f instanceof Promise||p instanceof Promise||d instanceof Promise?Promise.all([f,p,d]).then(([i,a,u])=>F(o,i,a,u)):F(o,f,p,d)}function F(e,r,t,n){switch(e){case"+":return r+t;case"-":return r-t;case"*":return r*t;case"/":return r/t;case"%":return r%t;case"=":return Array.isArray(r)&&!Array.isArray(t)?r.includes(t):Array.isArray(r)&&Array.isArray(t)?r.length===t.length&&r.every(o=>t.includes(o)):r==t;case"!=":return Array.isArray(r)&&!Array.isArray(t)?!r.includes(t):Array.isArray(r)&&Array.isArray(t)?!(r.length===t.length&&r.every(o=>t.includes(o))):r!=t;case"=~":{if(typeof t=="string"&&(t=[t,"i"]),!Array.isArray(t))throw new Error(`Invalid regexp: ${t}`);return new RegExp(t[0],t[1]).test(r)}case"!=~":{if(typeof t=="string"&&(t=[t,"i"]),!Array.isArray(t))throw new Error(`Invalid regexp: ${t}`);return!new RegExp(t[0],t[1]).test(r)}case"<":return r<t;case"<=":return r<=t;case">":return r>t;case">=":return r>=t;case"in":return t.includes(r);case"?":return r?t:n;case"??":return r??t;default:throw new Error(`Unupported operator: ${e}`)}}async function b(e,r,t,n){if(e.filter){let o=[];for(let s of r)await l(e.filter,s,t,n)&&o.push(s);r=o}return(await D(e,r.map(o=>({key:[],value:o})),t,n)).map(o=>o.value)}async function D(e,r,t,n){if(e.orderBy&&(r=r.sort((o,s)=>{let f=o.value,p=s.value;for(let{expr:d,desc:i}of e.orderBy){let a=l(d,f,t,n);if(a instanceof Promise)throw new Error("Cannot order by a promise");let u=l(d,p,t,n);if(u instanceof Promise)throw new Error("Cannot order by a promise");if(a<u||a===void 0)return i?1:-1;if(a>u||u===void 0)return i?-1:1}return 0})),e.select)for(let o=0;o<r.length;o++){let s=r[o].value,f={};for(let{name:p,expr:d}of e.select)f[p]=d?await l(d,s,t,n):s[p];r[o].value=f}if(e.distinct){let o=new Set,s=[];for(let f of r){let p=JSON.stringify(f.value);o.has(p)||(o.add(p),s.push(f))}r=s}if(e.limit){let o=await l(e.limit,{},t,n);r.length>o&&(r=r.slice(0,o))}return r}function E(e,r){if(r(e))return[e];let t=[];if(e.children)for(let n of e.children)t=[...t,...E(n,r)];return t}function S(e,r){return E(e,t=>t.type===r)[0]}function R(e,r){E(e,r)}typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function c(e,...r){return globalThis.syscall(e,...r)}var y={};x(y,{parseMarkdown:()=>W,renderParseTree:()=>Y});function W(e){return c("markdown.parseMarkdown",e)}function Y(e){return c("markdown.renderParseTree",e)}var h={};x(h,{deleteAttachment:()=>te,deleteFile:()=>ae,deletePage:()=>j,fileExists:()=>ce,getAttachmentMeta:()=>Z,getFileMeta:()=>ie,getPageMeta:()=>q,listAttachments:()=>X,listFiles:()=>ne,listPages:()=>z,listPlugs:()=>I,readAttachment:()=>ee,readFile:()=>oe,readPage:()=>G,writeAttachment:()=>re,writeFile:()=>se,writePage:()=>J});function z(){return c("space.listPages")}function q(e){return c("space.getPageMeta",e)}function G(e){return c("space.readPage",e)}function J(e,r){return c("space.writePage",e,r)}function j(e){return c("space.deletePage",e)}function I(){return c("space.listPlugs")}function X(){return c("space.listAttachments")}function Z(e){return c("space.getAttachmentMeta",e)}function ee(e){return c("space.readAttachment",e)}function re(e,r){return c("space.writeAttachment",e,r)}function te(e){return c("space.deleteAttachment",e)}function ne(){return c("space.listFiles")}function oe(e){return c("space.readFile",e)}function ie(e){return c("space.getFileMeta",e)}function se(e,r){return c("space.writeFile",e,r)}function ae(e){return c("space.deleteFile",e)}function ce(e){return c("space.fileExists",e)}var P={};x(P,{parse:()=>xe,stringify:()=>we});function xe(e){return c("yaml.parse",e)}function we(e){return c("yaml.stringify",e)}async function Se(e,r){let t=await h.readPage(e),n=await y.parseMarkdown(t),o;return R(n,s=>{if(s.type!=="FencedCode")return!1;let f=S(s,"CodeInfo");if(r&&!f||r&&!r.includes(f.children[0].text))return!1;let p=S(s,"CodeText");return p?(o=p.children[0].text,!0):!1}),o}async function M(e,r=["yaml"]){let t=await Se(e,r);if(t!==void 0)try{return P.parse(t)}catch(n){throw console.error("YAML Page parser error",n),new Error(`YAML Error: ${n.message}`)}}async function k(e){try{let r=await M("SECRETS",["yaml","secrets"]),t=[];for(let n of e){let o=r[n];if(o)t.push(o);else throw new Error(`No such secret: ${n}`)}return t}catch(r){throw r.message==="Not found"?new Error(`No such secret: ${e[0]}`):r}}function U(e){if(!Array.isArray(e))return{};let r={};return(e[0]==="and"?e.slice(1):e).forEach(n=>{if(!Array.isArray(n)||n.length!==3)return;let[o,s,f]=n;if(!Array.isArray(s)||s[0]!=="attr")return;let p=s[1];if(!Array.isArray(f))return;let d=f[1];switch(o){case"=":r[p]=d;break;case">":r[`${p}__gt`]=d;break;case"<":r[`${p}__lt`]=d;break}}),r}async function $({query:e}){let[r]=await k(["readwiseToken"]),t=[],n="https://readwise.io/api/v2/books/",o=1e4;e.limit&&(o=await l(e.limit,{},{},{}));let s=Math.min(o,1e3),f=U(e.filter);try{for(;n&&t.length<o;){let d=new URL(n);d.searchParams.set("page_size",s.toString()),Object.entries(f).forEach(([u,m])=>{d.searchParams.set(u,m)});let i=await fetch(d.toString(),{headers:{Authorization:`Token ${r}`}});if(!i.ok)throw new Error(`API request failed: ${i.status}`);let a=await i.json();t.push(...a.results),n=a.next}}catch(d){d instanceof Error?console.error(`Error: ${d.message}`):console.error("An unknown error occurred")}return b(e,t,{},{})}async function Q({query:e}){let[r]=await k(["readwiseToken"]),t=[],n="https://readwise.io/api/v2/highlights/",o=1e4;e.limit&&(o=await l(e.limit,{},{},{}));let s=Math.min(o,1e3),f=U(e.filter);try{for(;n&&t.length<o;){let d=new URL(n);d.searchParams.set("page_size",s.toString()),Object.entries(f).forEach(([u,m])=>{d.searchParams.set(u,m)});let i=await fetch(d.toString(),{headers:{Authorization:`Token ${r}`}});if(!i.ok)throw new Error(`API request failed: ${i.status} ${await i.text()}`);let a=await i.json();t.push(...a.results),n=a.next}}catch(d){d instanceof Error?console.error(`Error fetching highlights: ${d.message}`):console.error("An unknown error occurred while fetching highlights")}return b(e,t,{},{})}var B={getBooks:$,getHighlights:Q},K={name:"readwise",requiredPermissions:["fetch"],functions:{getBooks:{path:"readwise.ts:getBooks",events:["query:rwbook"]},getHighlights:{path:"readwise.ts:getHighlights",events:["query:rwhighlight"]}},assets:{}},mr={manifest:K,functionMapping:B};C(B,K);export{mr as plug};
